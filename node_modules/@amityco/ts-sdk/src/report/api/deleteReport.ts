import { getActiveClient } from '~/client/api/activeClient';

import { ingestInCache } from '~/cache/api/ingestInCache';

import REFERENCE_TYPES from '../constants/referenceTypes';
import { fireEvent } from '~/core/events';

/**
 * ```js
 * import { deleteReport } from '@amityco/ts-sdk'
 * const unflagged = await deleteReport('post', postId)
 * ```
 *
 * @param referenceType The type of thing to delete a report to, such as a post or a comment.
 * @param referenceId The ID of the thing to delete a report to.
 * @returns the deleted report result
 *
 * @category Report API
 * @async
 * */
export const deleteReport = async (
  referenceType: keyof typeof REFERENCE_TYPES,
  referenceId: string,
): Promise<boolean> => {
  const client = getActiveClient();
  client.log('report/deleteReport', { referenceType, referenceId });

  const { domainName } = REFERENCE_TYPES[referenceType];

  const { data } = await client.http.delete<
    Amity.PostPayload | Amity.CommentPayload | Amity.MessagePayload | Amity.UserPayload
  >(
    `/api/${
      referenceType === 'user'
        ? `v4/me/flags/${encodeURIComponent(referenceId)}`
        : `v3/${domainName}/${encodeURIComponent(referenceId)}/unflag`
    }`,
  );

  if (client.cache) ingestInCache(data);

  const event =
    referenceType === 'message'
      ? ('v3.message.didUpdate' as const)
      : (`${referenceType}.unflagged` as const);

  fireEvent(event, data);

  return !!data;
};
