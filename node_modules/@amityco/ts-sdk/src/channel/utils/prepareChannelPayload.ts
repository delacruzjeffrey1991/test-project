import { getActiveClient } from '~/client/api';

/** @hidden */
export const prepareChannelPayload = (
  payload: Amity.ChannelPayload,
): Amity.ChannelPayload<any, Amity.Channel> => {
  const client = getActiveClient();

  const channels: Amity.Channel[] = payload.channels.map(channel => {
    const channelUser = payload.channelUsers.find(
      channelUser =>
        channelUser.userId === client.userId && channel.channelId === channelUser.channelId,
    )!;

    const hasMention = channelUser
      ? channelUser.readToSegment < channelUser.lastMentionedSegment
      : false;
    const unreadCount =
      channelUser && channelUser.membership === 'member' && channel.messageCount
        ? Math.max(0, channel.messageCount - channelUser.readToSegment)
        : 0;

    return {
      ...channel,
      hasMention,
      unreadCount,
    };
  });

  return { ...payload, channels };
};
