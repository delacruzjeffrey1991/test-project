import { disableCache, enableCache } from '~/cache/api';

import {
  client,
  connectClient,
  disconnectClient,
  channel11,
  channelUser1,
  channelUser3,
} from '~/utils/tests';

import { onChannelMemberUnbanned } from '../onChannelMemberUnbanned';

describe('onChannelMemberBanned event', () => {
  beforeAll(async () => {
    await connectClient();
  });

  afterAll(async () => {
    await disconnectClient();
  });

  beforeEach(async () => {
    enableCache();
  });

  afterEach(disableCache);

  const channelPayload: Amity.ChannelMembershipPayload = {
    channelUsers: [channelUser1, channelUser3],
    channels: [channel11],
    files: [],
    users: [],
  };

  test('it should call callback with channel and unbanned member', () => {
    const callback = jest.fn();

    const unsub = onChannelMemberUnbanned(callback);
    client.emitter.emit('v3.channel.didUnban', channelPayload);

    unsub();

    expect(callback).toHaveBeenCalled();
    expect(callback).toHaveBeenCalledWith(channel11, channelUser3);
  });

  test('it should return an Unsubscriber', () => {
    const callback = jest.fn();

    const unsub = onChannelMemberUnbanned(callback);
    unsub();

    client.emitter.emit('v3.channel.didUnban', channelPayload);

    expect(callback).not.toHaveBeenCalled();
  });
});
