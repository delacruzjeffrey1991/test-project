import { getActiveClient } from '~/client/api';

import { dropFromCache, upsertInCache } from '~/cache/api';
import { fireEvent } from '~/core/events';

import { getComment } from './getComment';
import { getPost } from '~/post/api/getPost';

/**
 * ```js
 * import { deleteComment } from '@amityco/ts-sdk'
 * const success = await deleteComment('foobar')
 * ```
 *
 * Deletes a {@link Amity.Comment}
 *
 * @param commentId The {@link Amity.Comment} ID to delete
 * @return A success boolean if the {@link Amity.Comment} was deleted
 *
 * @category Comment API
 * @async
 */
export const deleteComment = async (
  commentId: Amity.Comment['commentId'],
  permanent = false,
): Promise<Amity.Comment> => {
  const client = getActiveClient();
  client.log('comment/deleteComment', commentId);

  const comment = await getComment(commentId);

  // API-FIX: This endpoint has not been implemented yet.
  await client.http.delete<{ success: boolean }>(
    `/api/v4/comments/${encodeURIComponent(commentId)}`,
    {
      params: {
        commentId,
        permanent,
      },
    },
  );

  // to support hard deletion
  const deleted = { ...comment.data, isDeleted: true };

  const post = await getPost(comment.data.referenceId);

  fireEvent('post.updated', { posts: [post.data] });
  fireEvent('comment.deleted', { comments: [deleted] });

  if (permanent) {
    setTimeout(() => {
      dropFromCache(['comment', 'get', commentId], true);
    }, 0);
  } else {
    upsertInCache(['comment', 'get', commentId], { isDeleted: true });
  }

  return deleted;
};
