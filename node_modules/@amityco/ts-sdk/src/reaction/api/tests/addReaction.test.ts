import { disableCache, enableCache, pullFromCache, pushToCache } from '~/cache/api';
import { onMessageUpdated } from '~/message/events';
import { addReaction } from '~/reaction/api';
import { client, message11 as message, pause } from '~/utils/tests';

describe('addReaction', () => {
  const cacheKey = ['message', 'get', message.messageId];

  beforeEach(enableCache);

  afterEach(disableCache);

  test('should optimistically add a reaction', async () => {
    const callback = jest.fn();
    pushToCache(cacheKey, message);
    onMessageUpdated(callback);

    const success = await addReaction.optimistically('message', message.messageId, 'like');

    expect(success).toEqual(true);
    expect(pullFromCache(cacheKey)?.data).toMatchObject({
      myReactions: ['like'],
      reactions: { like: 1 },
      reactionsCount: 1,
    });
    await pause();
    expect(callback).toBeCalledTimes(1);
  });

  test('should add a reaction', async () => {
    client.http.post = jest.fn().mockResolvedValue({ data: { addedId: 'reactionId' } });

    const success = await addReaction('message', message.messageId, 'like');

    expect(success).toEqual(true);
  });
});
